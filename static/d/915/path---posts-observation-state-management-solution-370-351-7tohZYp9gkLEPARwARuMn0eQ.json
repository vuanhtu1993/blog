{"data":{"site":{"siteMetadata":{"title":"Blog by AnhTus","subtitle":"Imagination more important than knowledge. Knowledge is limited. Imagination encircles the world\n      \n      from \"Albert Einstein\"\n      ","copyright":"© All rights reserved.","author":{"name":"Vu Anh Tu","twitter":"VuAnhTus"},"disqusShortname":"anhtus","url":"https://vuanhtu1993.github.io/blog/"}},"markdownRemark":{"id":"7657c92d-76b3-5849-9a5a-efd491bfb5d6","html":"<h3>Introduction Observation state management solution:</h3>\n<ul>\n<li>Lấy cảm hứng từ ý tưởng <code class=\"language-text\">Observer pattern</code> cùng việc học hỏi theo một trainer(FOZG) của mình tại FPT\nđã viết một công cụ có thể làm việc như là một thư viện quản lí trạng thái.</li>\n<li>Trong dự án tôi sử dụng 2 pattern chính là <code class=\"language-text\">Observer Pattern</code> và <code class=\"language-text\">Singleton Pattern</code>, trong một bài viết khác\nmình sẽ đề cấp đến một số pattern được sử dụng rất nhiều trong các dự án Javascript</li>\n</ul>\n<h4>Observer Pattern:</h4>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c700645a0456b0a68d3896ebf449e4b5/75abe/observation-pattern.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 825px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABR0lEQVQoz31SW4uCYBT8/v9vSQh6CPIhH7WHJLoodtWILC+ppWW3WeawLrEsO3A4fJ7PcWaOCt94v9/Sq6rC4XBAkiTI8xyPxwP3+1367XbDdDrFYrGAbdtot9swDAPb7Rae5yGOY6iG8PV6SV+tVmi1Wuh2uxgOhyjLUojP5zOiKIJlWRgMBjBNU/poNILruliv18iyDKpR1vTL5YLZbCZ1vV7xG5vNRlSOx2M4joPdbof9fo8wDOVd9UnWoK5rUfQJ3nk+n6KWcaRpKkS0yWen00ncqMYqCXiRsmnteDzKRXZeJJgt8/J9X5RxVhSFvMPO80+GlPsXuAgqJqiKGU8mE8ltPp/LgmiXZJyr5XKJIAgkEw555oBWqITbIwGzIwnV8ONURFd0QQdNKU3T0Ov1pPr9PnRdFxJur9PpyJnF34NzKv4PXxV1VSVTDPOcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"alt text\"\n        title=\"\"\n        src=\"/static/c700645a0456b0a68d3896ebf449e4b5/75abe/observation-pattern.png\"\n        srcset=\"/static/c700645a0456b0a68d3896ebf449e4b5/0db43/observation-pattern.png 240w,\n/static/c700645a0456b0a68d3896ebf449e4b5/cf4ee/observation-pattern.png 480w,\n/static/c700645a0456b0a68d3896ebf449e4b5/75abe/observation-pattern.png 825w\"\n        sizes=\"(max-width: 825px) 100vw, 825px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ul>\n<li>Như được biểu diễn trong sơ đồ UML, các đối tượng cần thiết là subject, observer và các đối tượng cụ thể.\nSubject có chứa tham chiếu đến các observers cụ thể để thông báo cho bất kỳ thay đổi.\nĐối tượng Observer là một lớp trừu tượng cho phép các observers cụ thể thực hiện phương thức thông báo</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">Subject</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Một stack các observers subscribe Subject</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    subscribeObserver<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    unsubscribeObserver<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>index <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    notifyObserver<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>index <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">notify</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    notifyAllObservers<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observers<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">notify</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> <span class=\"token function-variable function\">Observer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    notify<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Observer \"</span> <span class=\"token operator\">+</span> index <span class=\"token operator\">+</span> <span class=\"token string\">\" is notified!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> subject <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Subject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> observer1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> observer2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> observer3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> observer4 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeObserver</span><span class=\"token punctuation\">(</span>observer1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeObserver</span><span class=\"token punctuation\">(</span>observer2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeObserver</span><span class=\"token punctuation\">(</span>observer3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeObserver</span><span class=\"token punctuation\">(</span>observer4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">notifyObserver</span><span class=\"token punctuation\">(</span>observer2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Observer 2 is notified!</span>\n\nsubject<span class=\"token punctuation\">.</span><span class=\"token function\">notifyAllObservers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Observer 1 is notified!</span>\n<span class=\"token comment\">// Observer 2 is notified!</span>\n<span class=\"token comment\">// Observer 3 is notified!</span>\n<span class=\"token comment\">// Observer 4 is notified!</span></code></pre></div>\n<ul>\n<li>\n<p>Tư tưởng chính: ta xây dựng một nơi quản lí state tập trung của cả dự án gọi là <code class=\"language-text\">Store</code>,\ntại đây dự liệu sẽ được cập nhật => báo cho các <code class=\"language-text\">component</code> <code class=\"language-text\">subscribe</code> <code class=\"language-text\">Store</code> biết là đã có sự thay đổi\nstore và hãy render lại đi (đã có dữ liệu mới rồi)</p>\n</li>\n<li>\n<p>Implement thế nào?\nTừ ý tưởng và khi implement là cả môt sự khác biết rất lớn:</p>\n</li>\n<li>\n<p>Đầu tiên là vấn đề <code class=\"language-text\">Store</code> (Ở đây là ứng với Subject): Nơi lưu trữ dữ liệu, subscribe component và update dữ liệu\nNhưng mà vấn đề ở chỗ là không thể cứ component nào cũng tạo ra một Store được vì như thế còn gì là\nquản lí tập trung nữa. Điều này làm ta phải nghĩ ngay đến Singleton Pattern :))))\nKhó càng thêm khó => Lại thêm một pattern nữa mình băn khoăn (Xem định nghĩa ở dưới nhé)\nCó thể hiểu là mình cần phải tạo một object (đóng vai trò như là Singleton), tạo một lần\ndùng mãi mãi :))))\nTạm thời tắc tịt ở đây !!!</p>\n</li>\n<li>\n<p>Bây là vấn đề Observer: Cái gì là đóng vai trò thông báo cho component biết khi nào cần phải render\nlại ???. Câu trả lời là: hàm setState của HOC chứa component => Vì khi hàm setState này được\ntrigger thì component subscribe (HOC) sẽ được render lại => Component chính được render lại</p>\n</li>\n<li>\n<p>Ngon rồi, đã clear hơn một chút về phần subscribe và render lại => Tuy nhiên vấn đề 1\nthì còn nan giải. Vậy là cần phải tạo một <code class=\"language-text\">instance</code> của <code class=\"language-text\">Store</code> tổng để import vào HOC => Một cách\nđể tạo ra Singleton.</p>\n</li>\n</ul>\n<p>Nhưng mình đang cần phải tạo ra nhiều Store để phục vụ các ứng dựng rỉêng => Giống redux nên thay vì tạo\nsingleton là Store ta sẽ tạo <code class=\"language-text\">singleton</code> là các Observation chứ hàm connect HOC với component </p>\n<p>Chi tiết code xem tại đây: <a href=\"https://github.com/vuanhtu1993/observation-state\">https://github.com/vuanhtu1993/observation-state</a></p>\n<h4>Singleton Pattern</h4>","fields":{"tagSlugs":["/tags/react/","/tags/state-management/","/tags/observation-state/"]},"frontmatter":{"title":"Introduction Observation state management solution","tags":["React","State management","Observation state"],"date":"2019-05-09T00:00:00.000Z","description":"New approach for state management using observer pattern"}}},"pageContext":{"slug":"/posts/observation-state-management-solution/"}}